{{
    config(
        materialized="table",
        snowflake_warehouse="AAVE",
        database="aave",
        schema="raw",
        alias="fact_v2_collector",
    )
}}


WITH 

tokens as (
    SELECT LOWER(a_token) AS a_token, LOWER(priced_token) AS priced_token
    FROM (
        VALUES
        ('0x98C23E9d8f34FEFb1B7BD6a91B7FF122F4e16F5c', '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48'),
        ('0x23878914EFE38d27C4D67Ab83ed1b93A74D4086a', '0xdAC17F958D2ee523a2206206994597C13D831ec7'),
        ('0xae78736Cd615f374D3085123A210448E74Fc6393', '0xae78736Cd615f374D3085123A210448E74Fc6393'),
        ('0x40D16FC0246aD3160Ccc09B8D0D3A2cD28aE6C2f', '0x40D16FC0246aD3160Ccc09B8D0D3A2cD28aE6C2f'),
        ('0x4d5F47FA6A74757f35C14fD3a6Ef8E3C9BC514E8', '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2'),
        ('0xBcca60bB61934080951369a648Fb03DF4F96263C', '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48'),
        ('0x3Ed3B47Dd13EC9a98b44e6204A523E766B225811', '0xdAC17F958D2ee523a2206206994597C13D831ec7'),
        ('0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0', '0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0'),
        ('0x5Ee5bf7ae06D1Be5997A1A72006FE6C607eC6DE8', '0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599'),
        ('0x018008bfb33d285247A21d44E50697654f754e63', '0x6B175474E89094C44Da98b954EedeAC495271d0F'),
        ('0x028171bCA77440897B824Ca71D1c56caC55b68A3', '0x6B175474E89094C44Da98b954EedeAC495271d0F'),
        ('0x0B925eD163218f6662a35e0f0371Ac234f9E9371', '0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0'),
        ('0x030bA81f1c18d280636F32af80b9AAd02Cf0854e', '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2'),
        ('0x5E8C8A7243651DB1384C0dDfDbE39761E8e7E51a', '0x514910771AF9Ca656af840dff83E8264EcF986CA'),
        ('0x7D1AfA7B718fb893dB30A3aBc0Cfc608AaCfeBB0', '0x7D1AfA7B718fb893dB30A3aBc0Cfc608AaCfeBB0'),
        ('0x6B175474E89094C44Da98b954EedeAC495271d0F', '0x6B175474E89094C44Da98b954EedeAC495271d0F'),
        ('0x101cc05f4A51C0319f570d5E146a8C625198e636', '0x0000000000085d4780B73119b644AE5ecd22b376'),
        ('0xA361718326c15715591c299427c62086F69923D9', '0x4Fabb145d64652a948d72533023f6E7A623C7C53'),
        ('0xC7B4c17861357B8ABB91F25581E7263E08DCB59c', '0xC011a73ee8576Fb46F5E1c5751cA3B9Fe0af2a6F'),
        ('0xD37EE7e4f452C6638c96536e68090De8cBcdb583', '0xa0E5A19E091BBe241E655997E50da82DA676b083'),
        ('0xA700b4eB416Be35b2911fd5Dee80678ff64fF6C9', '0x7Fc66500c84A76Ad7e9c93437bFc5Ac33E2DDaE9'),
        ('0x9ff58f4fFB29fA2266Ab25e75e2A8b3503311656', '0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599'),
        ('0x6C5024Cd4F8A59110119C56f8933403A539555EB', '0x57Ab1ec28D129707052df4dF418D58a2D46d5f51'),
        ('0xCc9EE9483f662091a1de4795249E24aC0aC2630f', '0xae78736Cd615f374D3085123A210448E74Fc6393'),
        ('0x3Fe6a295459FAe07DF8A0ceCC36F37160FE86AA9', '0x5f98805A4E8be255a32880FDeC7F6728C6568bA0'),
        ('0xB76CF92076adBF1D9C39294FA8e7A67579FDe357', '0xD33526068D116cE69F19A9ee46F0bd304F21A51f'),
        ('0x8A458A9dc9048e005d22849F470891b840296619', '0x9f8F72aA9304c8B593d555F12eF6589cC3A579A2'),
        ('0xF6D2224916DDFbbab6e6bd0D1B7034f4Ae0CaB18', '0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984'),
        ('0x977b6fc5dE62598B08C85AC8Cf2b745874E8b78c', '0xBe9895146f7AF43049ca1c1AE358B0541Ea49704'),
        ('0x1494CA1F11D487c2bBe4543E90080AeBa4BA3C2b', '0x1494CA1F11D487c2bBe4543E90080AeBa4BA3C2b'),
        ('0xd4e245848d6E1220DBE62e155d89fa327E43CB06', '0x853d955aCEf822Db058eb8505911ED77F175b99e'),
        ('0xc9BC48c72154ef3e5425641a3c747242112a46AF', '0x03ab458634910AaD20eF5f1C8ee96F1D6ac54919'),
        ('0xc713e5E149D5D0715DcD1c156a020976e7E56B88', '0x9f8F72aA9304c8B593d555F12eF6589cC3A579A2'),
        ('0x7B95Ec873268a6BFC6427e7a28e396Db9D0ebc65', '0xD533a949740bb3306d119CC777fa900bA034cd52'),
        ('0xa685a61171bb30d4072B338c80Cb7b2c865c873E', '0x0F5D2fB29fb7d3CFeE444a200298f468908cC942'),
        ('0xB9D7CB55f463405CDfBe4E90a6D2Df01C2B92BF1', '0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984'),
        ('0xd24946147829DEaA935bE2aD85A3291dbf109c80', '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48'),
        ('0x39C6b3e42d6A679d7D776778Fe880BC9487C2EDA', '0xdd974D5C2e2928deA5F71b9825b8b646686BD200'),
        ('0x2516E7B3F76294e03C42AA4c5b5b4DCE9C436fB8', '0xba100000625a3754423978a60c9317c58a424e3D'),
        ('0x514910771AF9Ca656af840dff83E8264EcF986CA', '0x514910771AF9Ca656af840dff83E8264EcF986CA'),
        ('0x9A44fd41566876A39655f74971a3A6eA0a17a454', '0x5A98FcBEA516Cf06857215779Fd812CA3beF1B32'),
        ('0x71Aef7b30728b9BB371578f36c5A1f1502a5723e', '0x111111111117dC0aa78b770fA6A738034120C302'),
        ('0xaC6Df26a590F08dcC95D5a4705ae8abbc88509Ef', '0xF629cBd94d3791C9250152BD8dfBDF380E2a3B9c'),
        ('0x79bE75FFC64DD58e66787E4Eae470c8a1FD08ba4', '0x6B175474E89094C44Da98b954EedeAC495271d0F'),
        ('0xDf7FF54aAcAcbFf42dfe29DD6144A69b629f8C9e', '0xE41d2489571d322189246DaFA5ebDe1F4699F498'),
        ('0x272F97b7a56a387aE942350bBC7Df5700f8a4576', '0xba100000625a3754423978a60c9317c58a424e3D'),
        ('0x05Ec93c0365baAeAbF7AefFb0972ea7ECdD39CF1', '0x0D8775F648430679A709E98d2b0Cb6250d2887EF'),
        ('0x13B2f6928D7204328b0E8E4BCd0379aA06EA21FA', '0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599'),
        ('0x7Fc66500c84A76Ad7e9c93437bFc5Ac33E2DDaE9', '0x7Fc66500c84A76Ad7e9c93437bFc5Ac33E2DDaE9')
    ) AS t(a_token, priced_token)
)
, base AS (
    select
        to_address,
        from_address,
        contract_address,
        priced_token,
        block_timestamp::date as date,
        amount,
        min(block_timestamp::date) OVER() as min_date
    FROM ethereum_flipside.core.ez_token_transfers
    inner join tokens on lower(contract_address) = lower(a_token)
)
,  date_range AS (
    SELECT *
        FROM (
            SELECT
                min_date + SEQ4() AS date
            FROM base
        )
    WHERE date <= TO_DATE(SYSDATE())
)
, flows as (
    SELECT
        date,
        contract_address,
        priced_token,
        SUM(CASE WHEN to_address = lower('0x464C71f6c2F760DdA6093dCB91C24c39e5d6e18c') THEN amount ELSE 0 END) AS amount_in,
        SUM(CASE WHEN from_address = lower('0x464C71f6c2F760DdA6093dCB91C24c39e5d6e18c') THEN amount ELSE 0 END) AS amount_out
    FROM base
    GROUP BY 1, 2, 3
)
, prices as (
    select
        hour::date as date
        , token_address
        , avg(price) as price
    from ethereum_flipside.price.ez_prices_hourly
    where token_address in (select distinct priced_token from tokens)
    group by 1, 2
)

SELECT
    dr.date AS date
    , 'ethereum' as chain
    , contract_address as token_address
    , SUM(COALESCE(f.amount_in, 0) - COALESCE(f.amount_out, 0)) OVER (partition by contract_address ORDER BY dr.date) as amount_nominal
    , amount_nominal * p.price as amount_usd
FROM date_range dr
LEFT JOIN flows f
    ON f.date = dr.date
LEFT JOIN prices p 
    on p.date = dr.date 
    and lower(p.token_address) = lower(f.priced_token)
