name: docs
on:
  push:
    branches: main
  pull_request_target:
    branches: main
env:
  SYSTEM_SNOWFLAKE_USER: ${{ secrets.SYSTEM_SNOWFLAKE_USER }}
  SYSTEM_SNOWFLAKE_PASSWORD: ${{ secrets.SYSTEM_SNOWFLAKE_PASSWORD }}
  SYSTEM_SNOWFLAKE_ROLE: ${{ secrets.SYSTEM_SNOWFLAKE_ROLE }}
jobs:
  write-dbt-to-pages-repo:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # - name: Generate a Github App token
      #   id: generate_token
      #   uses: actions/create-github-app-token@v1
      #   with:
      #     app-id: ${{ secrets.ARTEMIS_CI_APP_ID }}
      #     private-key: ${{ secrets.ARTEMIS_CI_APP_PRIVATE_KEY }}
      #     owner: ${{ github.repository_owner }}
      #     repositories: "artemis-xyz.github.io"

      - name: Init dbt
        uses: ./.github/actions/init-dbt

      - name: Generate docs
        id: generateDocs
        run: |
          exit 1
          dbt deps
          dbt docs generate --threads 16 --target prod
          git diff
          mkdir generated_dbt_docs
          mv "target/index.html" "target/manifest.json" "target/catalog.json" "target/partial_parse.msgpack" generated_dbt_docs

      - name: Send Slack Alert
        if: failure() && steps.generateDocs.outcome == 'failure'
        uses: slackapi/slack-github-action@v2.1.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: C03KWK6G7ME
            blocks:
              - type: "header"
                text:
                  type: "plain_text"
                  text: "ðŸš¨ðŸš¨ðŸš¨ DBT Deploy FAILURE ðŸš¨ðŸš¨ðŸš¨"
                  emoji: true
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "- <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Failed Run>\n - <${{ github.event.pull_request.html_url || github.event.head_commit.url }}|PR>\n - This PR was opened by `${{ github.event.pull_request.user.login }}`"

      # - name: Push to Github Pages repo
      #   uses: cpina/github-action-push-to-another-repository@v1.7.2
      #   env:
      #     API_TOKEN_GITHUB: ${{ steps.generate_token.outputs.token }}
      #   with:
      #     source-directory: 'generated_dbt_docs'
      #     target-directory: 'dbt'
      #     destination-github-username: 'artemis-xyz'
      #     destination-repository-name: 'artemis-xyz.github.io'
      #     user-name: 'Artemis CI'
      #     commit-message: 'update DBT docs'
